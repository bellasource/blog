---
title: 单点登录解决方案
date: 2020/08/31
---

{% blockquote %}
单点登录是指在同一账号平台下的多个应用子系统中，用户只需要登录一次，即可访问所有相互信任的应用系统。
其本质为多个应用子系统共享登录状态。
在用户初始访问子系统时，需要跳转到认证中心登录，并在认证中心更新用户的登录状态，在回跳到子系统
{% endblockquote %}

## 通过认证中心管理用户登录信息

在子系统中，创建signin，signout，callback三个页面，用于登录登出的跳转逻辑

技术前提：通过window.open和window.location跳转，能读取同源地址的session

signout：在此页面中，移除token，并调用认证中心接口，修改用户登录状态
signin：在此页面中，调用认证中心接口，认证中心是否登录返回跳登录或者是子系统页面
callback：此页面用于登录成功后，认证中心认证用户为已登录的跳转页，用于获取用户信息如token，userid等，完成后打开子系统首页。

### 初次登录

- 访问登录页，登录成功以后，后台携带登录凭证码重定向到子系统callback页面获取用户相关信息，如token，userid，回跳子系统地址等，并保存在session中；

- window.location = 回跳地址

### 第二次进入子页面

- 由于session生命周期的问题，第二次进入子系统，无token，接口401，跳转到signin页面，

  - **经认证中心认证为登录状态**，认证中心携带code回跳到callback页，获取用户信息，完成登录后，跳到子系统首页。

  - **经认证中心认证为未登录状态**，认证中心回跳到登录页

### 登出

- 在子系统，触发登出请求，重定向到子系统signout页，移除token，携带token向后台获取并跳转认证中心地址，将用户状态改为未登录

- 认证中心回跳至子系统首页，ajax请求401，跳出到signin页面，获取登录页所在地址，并跳转到登录页

## 通过localstorage实现单点登录

当各子系统主域名一致，用户在一个子系统A中登录以后，直接将token保存在localstorage中，在同源的子系统B中，也可访问到localstorage中的token